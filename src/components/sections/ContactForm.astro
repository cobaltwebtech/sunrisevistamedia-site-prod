---
const turnstileSiteKey = import.meta.env.TURNSTILE_PUBLIC_KEY;

let errorMessage: string | null = null;

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const result = formSchema.safeParse(Object.fromEntries(formData));

    if (!result.success) {
      errorMessage = "Please fill out all required fields correctly.";
    } else {
      const { "cf-turnstile-response": turnstileResponse, ...formFields } = result.data;

      // Verify the Turnstile token
      const verificationResponse = await fetch(
        "https://challenges.cloudflare.com/turnstile/v0/siteverify",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            secret: import.meta.env.TURNSTILE_SECRET_KEY,
            response: turnstileResponse,
          }),
        }
      );

      const verificationResult = await verificationResponse.json();

      if (!verificationResult.success) {
        errorMessage = "CAPTCHA verification failed. Please try again.";
      } else {
        // Proceed with form submission
        const response = await fetch(`${Astro.url.origin}/api/sendEmailContact`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        // Redirect to the confirmation page
        return Astro.redirect('/contact/submission-received/', 302);
      }
    }
  } catch (e) {
    console.error(`Error: ${e instanceof Error ? e.message : String(e)}`);
    errorMessage = "An unexpected error occurred. Please try again.";
  }
}
---

<form id="contactForm">
    <div>
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
    </div>
    <div>
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
    </div>
    <div>
        <label for="message">Message:</label>
        <textarea id="message" name="message" required></textarea>
    </div>
    <div class="cf-turnstile" data-sitekey={turnstileSiteKey}></div>
    <button type="submit">Send</button>
</form>
<div id="formMessage"></div>
